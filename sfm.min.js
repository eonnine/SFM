(function(f){if("function"===typeof define&&define.amd)define(function(){return f});else if("object"===typeof module&&"object"===typeof module.exports)module.exports=f;else for(var e in f)this[e]=f[e]})(function(f,e){var g=Object.prototype.hasOwnProperty,c=function(a){if(!(this instanceof c))throw new SyntaxError('[SFM] "new" constructor operator is required');this.requiredValidator(a);this.fileMap=new f;this.isIngRemove=this.isIngDownload=this.isIngUpload=!1;this.fileAreaInnerHTML="";this.option=
a;this.callee={};this.init(a);return this.callee};c.prototype.requiredValidator=function(a){if(null==a||!g.call(a,"id"))throw new SyntaxError('[SFM] constructor property "id" is required');};c.prototype.config={key:{fileIdx:"number",fileSeq:"string"},fix:{item:"item",item_key_area:"item-key-area",file_upload:"upload-file",file_remove:"remove-file",file_download:"download-file",input_file:"input-file",item_area:"file-area"},file:{file_size:"52428800",file_count:0,file_extension:[],file_extension_except:[],
file_parameter_name:"file",file_list_parameter_name:"files"},message:{file_remove:"\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?",file_already_exist:"\ub3d9\uc77c\ud55c \uc774\ub984\uc758 \ud30c\uc77c\uc774 \uc774\ubbf8 \ub4f1\ub85d\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4",file_size_max_overflow:"\ud5c8\uc6a9\ub41c \ud06c\uae30(50mb)\ubcf4\ub2e4 \uc6a9\ub7c9\uc774 \ud070 \ud30c\uc77c\uc785\ub2c8\ub2e4",file_count_over:"\ud5c8\uc6a9\ub41c \uac1c\uc218\ub97c \ucd08\uacfc\ud569\ub2c8\ub2e4",file_extension:"\ud5c8\uc6a9\ub41c \ud655\uc7a5\uc790\uac00 \uc544\ub2d9\ub2c8\ub2e4.",
file_extension_except:"\ud5c8\uc6a9\ub41c \ud655\uc7a5\uc790\uac00 \uc544\ub2d9\ub2c8\ub2e4.",file_get_error:"\ud30c\uc77c \ubaa9\ub85d\uc744 \ubd88\ub7ec\uc624\ub294 \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",file_upload_error:"\ud30c\uc77c \uc5c5\ub85c\ub4dc \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",file_remove_error:"\ud30c\uc77c \uc0ad\uc81c \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",file_download_error:"\ud30c\uc77c \ub2e4\uc6b4\ub85c\ub4dc \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",
file_upload_is_ing:"\uc5c5\ub85c\ub4dc \uc911\uc785\ub2c8\ub2e4",file_remove_is_ing:"\uc0ad\uc81c \uc911\uc785\ub2c8\ub2e4",file_download_is_ing:"\ub2e4\uc6b4\ub85c\ub4dc \uc911\uc785\ub2c8\ub2e4"},layout:function(a,b){return'<fieldset><button id="'+b+'" style="float:right; position:relative; bottom:13px;">upload</button><div id="'+a+'" style="z-index:1;" width="100%" height="100%" default-class-dropzone><p>\ud30c\uc77c\uc744 \uc5ec\uae30\uc5d0 \ub4dc\ub798\uadf8\ud558\uac70\ub098 \ud074\ub9ad\ud558\uc138\uc694</p></div></fieldset>'},
item:function(a,b,d){return'<span style="z-index:10;"><p>&nbsp;&nbsp;<b id="'+d+'" style="width:12px; height:12px; margin-left:5px; font-size:12px; cursor:pointer;">\u25bc</b>&nbsp;file: <strong>'+a.name+"</strong>&nbsp;&nbsp;&nbsp;type: <strong>"+a.type+"</strong>&nbsp;&nbsp;&nbsp;size: <strong>"+a.size+'</strong>bytes<data style="display:none;"></data><b style="width:12px; height:12px; margin-left:5px; font-size:12px; cursor:pointer;" id="'+b+'">X</b></p></span>'},url:{file_get_list:"",file_upload:"",
file_remove:"",file_download:""},event:{file_upload:"click",file_remove:"click",file_download:"click"},eventHandler:{layout_create_after:function(a){var b=function(a){a.stopPropagation();a.preventDefault();a.target.className="mouseover"==a.type||"mouseenter"==a.type?"mhover":""},d=function(a){a.stopPropagation();a.preventDefault();a.target.className="dragover"==a.type||"dragenter"==a.type?"hover":""};a=a.fileArea;a.addEventListener("mouseover",b,!1);a.addEventListener("mouseenter",b,!1);a.addEventListener("mouseleave",
b,!1);a.addEventListener("dragover",d,!1);a.addEventListener("dragenter",d,!1);a.addEventListener("dragleave",d,!1)},file_upload_before:function(a){console.log("uploadStart")},file_upload_after:function(a){console.log("uploadEnd")},file_remove_before:function(a){console.log("removeStart")},file_remove_after:function(a){console.log("removeEnd")},file_download_before:function(){console.log("downloadStart")},file_download_after:function(a){console.log("downloadEnd")}}};c.prototype.getConfig=function(){var a=
this.searchProp(this.option,arguments);null===a&&(a=this.searchProp(this.config,arguments));return a};c.prototype.searchProp=function(a,b){var d,h;for(d=0;h=b[d];d++)if(g.call(a,h))a=a[h];else return null;return a};c.prototype.setConfig=function(a){this.initConfig(a)};c.prototype.initConfig=function(a,b){b=b?b:this.config;for(var d in a)"fix"!==d&&("object"===typeof b[d]&&g.call(b,d)&&"Object"==b[d].constructor.name?this.initConfig(a[d],b[d]):b[d]=a[d])};c.prototype.getElement=function(a){return document.getElementById(a)};
c.prototype.makeElementId=function(a){this.elementId={};this.elementId.item=this.makeConfigId("fix","item");this.elementId.fileArea=this.makeConfigId("fix","item_area");this.elementId.fileUpload=this.makeConfigId("fix","file_upload");this.elementId.fileRemove=this.makeConfigId("fix","file_remove");this.elementId.itemKeyArea=this.makeConfigId("fix","item_key_area");this.elementId.fileDownload=this.makeConfigId("fix","file_download");this.elementId.fileInputElement=this.makeConfigId("fix","input_file")};
c.prototype.makeConfigId=function(){return this.addSeparator(this.option.id,this.getConfig.apply(this,arguments))};c.prototype.addSeparator=function(){var a,b=arguments.length,d="";for(a=0;a<b;a++)d+=arguments[a]+"-";return d.slice(0,-1)};c.prototype.makeCallee=function(){this.callee.getFilesFromUrl=this.getFilesFromUrl.bind(this);this.callee.uploadFile=this.uploadFile.bind(this);this.callee.getNewFiles=this.getNewFiles.bind(this);this.callee.getFileToFormData=this.getFileToFormData.bind(this);this.callee.getNewFileToFormData=
this.getNewFileToFormData.bind(this)};c.prototype.freezeProperty=function(){Object.freeze(this.callee);Object.defineProperties(this,{fileMap:{configurable:!1,writable:!1},isIngUpload:{configurable:!1},isIngDownload:{configurable:!1},isIngRemove:{configurable:!1}})};c.prototype.init=function(a){this.makeElementId();this.createLayout();this.createDefaultEventListener();this.makeCallee();this.freezeProperty()};c.prototype.createLayout=function(){var a=this.elementId.fileArea,b=this.elementId.fileUpload,
d=this.getElement(this.option.id);d.innerHTML=this.getConfig("layout")(a,b);d.insertAdjacentHTML("afterbegin",'<input type="file" id="'+this.elementId.fileInputElement+'" multiple="multiple" style="display:none;"/>');a=this.getElement(a);b=this.getElement(b);null!=b&&this.addCustomEvent(b,this.getConfig("event","file_upload"),this.uploadFile.bind(this));this.callConfigEventHandler("layout_create_after",{fileArea:a,fileUploadElement:b})};c.prototype.createDefaultEventListener=function(){var a=this.getElement(this.elementId.fileArea),
b=this.getElement(this.elementId.fileInputElement);this.addCustomEvent(a,"click",this.openInputFile.bind(this)).addCustomEvent(a,"drop",this.addNewFile.bind(this)).addCustomEvent(a,"mouseover",this.preventEvent.bind(this)).addCustomEvent(a,"mouseenter",this.preventEvent.bind(this)).addCustomEvent(a,"dragover",this.preventEvent.bind(this)).addCustomEvent(a,"mouseenter",this.preventEvent.bind(this)).addCustomEvent(b,"change",this.addNewFile.bind(this))};c.prototype.openInputFile=function(a){this.preventEvent(a);
this.getElement(this.elementId.fileInputElement).click()};c.prototype.addNewFile=function(a){this.preventEvent(a);for(var b=a.target.files||a.dataTransfer.files,d=0,h;h=b[d];d++){if(!this.addFileStopValidator(h))return;var c=this.makeItemKey(h.name);h=this.createNewFile(h,c);this.removeDefaultHTML();this.addFileToFileMap(h,!0);this.addItem(h)}a.target.value=""};c.prototype.addFileStopValidator=function(a){var b=a.name;b=b.substring(b.lastIndexOf(".")+1,b.length);var d=this.getConfig("file","file_extension"),
h=this.getConfig("file","file_extension_except"),c=this.getConfig("file","file_count");if(a.size>this.getConfig("file","file_size"))return alert(this.getConfig("message","file_size_max_overflow")),!1;if(0!==c&&c<this.fileMap.size())return alert(this.getConfig("message","file_count_over")),!1;for(a=0;c=d[a];a++)if(b!==c)return alert(this.getConfig("message","file_extension")),!1;for(a=0;d=h[a];a++)if(b===d)return alert(this.getConfig("message","file_extension_except")),!1;return!0};c.prototype.createNewFile=
function(a,b){var d=new Blob([a],{type:a.type});d.name=b;d.lastModified=a.lastModified||0;d.lastModifiedDate=a.lastModifiedDate||0;return d};c.prototype.makeItemKey=function(a){for(var b=a,d=1,h;this.fileMap.isContainsKey(b);)d++,h=a.substring(a.lastIndexOf("."),a.length),b=a.substring(0,a.lastIndexOf(".")),b=b+" ("+d+")"+h;return b};c.prototype.addFile=function(a){for(var b=0,d;d=a[d];b++)g.call(d,"name")?(this.removeDefaultHTML(),this.addFileToFileMap(d,!1),this.addItem(d)):console.error('[SFM] not exists attribute "name" in file object',
d)};c.prototype.addFileToFileMap=function(a,b){a.isNewFile=b;this.fileMap.put(a.name,a)};c.prototype.removeDefaultHTML=function(){if(0==this.fileMap.length){var a=this.getElement(this.elementId.fileArea);this.fileAreaInnerHTML=a.innerHTML;a.innerHTML=""}};c.prototype.insertDefaultHTML=function(){0==this.fileMap.length&&(this.getElement(this.elementId.fileArea).innerHTML=this.fileAreaInnerHTML,this.fileAreaInnerHTML="")};c.prototype.addItem=function(a){var b=this.addSeparator(this.elementId.fileRemove,
a.name),d=this.addSeparator(this.elementId.fileDownload,a.name),h=this.getElement(this.elementId.fileArea),c=this.getConfig("key"),g=this.elementId.itemKeyArea,e="",f=this.addSeparator(this.elementId.item,a.name),k=this.getConfig("item")(a,b,d);Object.keys(c).forEach(function(b,d){0===d&&(e="<span "+g+">");e+='<input type="hidden" id="'+b+'" value="'+(a[b]?a[b]:"")+'"/>';d==c.length-1&&(e+="</span>")});h.insertAdjacentHTML("beforeend",'<span id="'+f+'">'+k+e+"</span>");b=this.getElement(b);d=this.getElement(d);
b&&this.addCustomEvent(b,this.getConfig("event","file_remove"),this.removeFile.bind(this,f,this.createNewFile(a,a.name)));d&&this.addCustomEvent(d,this.getConfig("event","file_download"),this.downloadFile.bind(this,f,this.createNewFile(a,a.name)))};c.prototype.removeFile=function(a,b,d){if(this.isIngRemove)return alert(this.getConfig("message","file_remove_is_ing")),!1;if(!confirm(this.getConfig("message","file_remove")))return!1;this.isIngRemove=!0;this.preventEvent(d);var c=this;d=new e;var g=b.name,
f=c.getElement(a),k=c.makeParamFile(b),l=c.getConfig("url","file_remove");d.then(function(a,d){c.callConfigEventHandler("file_remove_before",{file:b,item:f})?a():d()}).then(function(a,b){if(null==l||""===c.trim(l))l=location.href;try{c.ajax.post(l,k,function(b){a(b)})}catch(p){console.error("[SFM] fail remove file:",l,p),b(),alert(c.getConfig("message","file_remove_error"))}}).then(function(a,b,d){c.removeSelf(f);c.fileMap.remove(g);c.callConfigEventHandler("file_remove_after",{response:d});c.isIngRemove=
!1;c.insertDefaultHTML()})};c.prototype.downloadFile=function(a,b,d){this.isIngDownload=!0;this.preventEvent(d);var c=this;d=new e;var g=c.getElement(a),f=c.getConfig("url","file_download");d.then(function(a,d){c.callConfigEventHandler("file_download_before",{file:b,item:g})?a():d()}).then(function(a,b){if(null!=f&&""!==c.trim(f))try{location.href=f,a()}catch(n){console.error("[SFM] fail download file:",f,n),b(),alert(c.getConfig("message","file_download_error"))}else console.warn("[SFM] downloadURL is not define")}).then(function(){c.callConfigEventHandler("file_download_after");
c.isIngDownload=!1})};c.prototype.uploadFile=function(){if(this.isIngUpload)return alert(this.getConfig("message","file_upload_is_ing")),!1;this.isIngUpload=!0;var a=this,b=new e,d=a.makeParamFiles(),c=a.getConfig("url","file_upload");b.then(function(b,d){a.callConfigEventHandler("file_upload_before")?b():d()}).then(function(b,g){if(null==c||""===a.trim(c))c=location.href;try{a.ajax.post(c,d,function(a){b(a)})}catch(m){console.error("[SFM] fail upload:",c,m),g(),alert(a.getConfig("message","file_upload_error"))}}).then(function(b,
d,c){a.callConfigEventHandler("file_upload_after",{response:c});a.isIngUpload=!1})};c.prototype.removeSelf=function(a){a.parentNode.removeChild(a)};c.prototype.makeParamFile=function(a){var b=new FormData;this.setParamFormData(b,a,!1);return b};c.prototype.makeParamFiles=function(a,b){a=a?a:new FormData;var d=this.fileMap.array();b=b?b:!1;d.forEach(function(d,c){this.setParamFormData(a,d,!0,c,b)}.bind(this));return a};c.prototype.setParamFormData=function(a,b,d,c,e){var h=this.addSeparator(this.elementId.item,
b.name);h=this.getElement(h).querySelector("["+this.elementId.itemKeyArea+"]").childNodes;var f=this.getConfig("key"),k;if(!e||e&&b.isNewFile){for(k=0;k<h.length;k++)e=h[k],g.call(f,e.id)&&a.append(this.getParamName(d,!1,c,e.id),"number"===f[e.id].toLowerCase()?Number(e.value):String(e.value));a.append(this.getParamName(d,!0,c),b,b.name)}};c.prototype.getParamName=function(a,b,d,c){d=this.getConfig("file","file_list_parameter_name")+"["+d+"].";var e=this.getConfig("file","file_parameter_name");return a?
b?d+e:d+c:b?e:c};c.prototype.getFileToFormData=function(a){return this.makeParamFiles(a)};c.prototype.getNewFileToFormData=function(a){return this.makeParamFiles(a,!0)};c.prototype.getFilesFromUrl=function(a){var b=this.getConfig("url","file_get_list"),d=this;try{d.ajax.get(b,a,function(a){d.addFile(a)})}catch(h){console.error("[SFM] getFilesFromUrl:",b,h),alert(d.getConfig("message","file_get_error"))}};c.prototype.getFiles=function(){var a=[];this.fileMap.each(function(b,d){a.push(b.value)});return a};
c.prototype.getNewFiles=function(){var a=[];this.fileMap.each(function(b,d){b.value.isNewFile&&a.push(b.value)});return a};c.prototype.addCustomEvent=function(a,b,d){void 0===a._$sfmEventListeners&&(a._$sfmEventListeners={});a._$sfmEventListeners[b]=function(a){a.stopPropagation();a.preventDefault();d(a)};a.addEventListener(b,a._$sfmEventListeners[b],!1);g.call(a._$sfmEventListeners,"DOMNodeRemovedFromDocument")||this.addCustomEvent(a,"DOMNodeRemovedFromDocument",function(a){this._$sfmEventListeners&&
(Object.keys(this._$sfmEventListeners).forEach(function(a){this.removeEventListener(a,this._$sfmEventListeners[a]);delete this._$sfmEventListeners[a]}.bind(this)),delete this._$sfmEventListeners)}.bind(this));return this};c.prototype.callConfigEventHandler=function(a,b){var d=this.option;b=void 0===b?{}:b;b.self=this.getElement(d.id);var c=this.searchProp(this.config,["eventHandler",a])(this.copyObject(b));!1!==c&&g.call(d,"eventHandler")&&g.call(d.eventHandler,a)&&(c=d.eventHandler[a](this.copyObject(b)));
return!1===c?!1:!0};c.prototype.preventEvent=function(a){a.stopPropagation();a.preventDefault()};c.prototype.copyObject=function(a){if("string"===typeof a)var b=a;else{b={};for(var c in a)b[c]=a[c]}return b};c.prototype.trim=function(a){return a.replace(/\s/g,"")};c.prototype.ajax={get:function(a,b,c,e){this.xhr("GET",a,b,c,e)},post:function(a,b,c,e){this.xhr("POST",a,b,c,e)},xhr:function(a,b,c,e,g){var d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.onload=function(a){4==
this.readyState&&200==this.status?e&&e(a.target.response,d):g&&g(d)};d.open(a,b,!0);d.setRequestHeader("encType","multipart/form-data");d.send(c)}};var k=function(a){if(!(this instanceof k))throw new SyntaxError('[SFMGrid] "new" constructor operator is required');this.requiredValidator(a);this.fileMap=Object.create(null);this.rowIdColumn=a.rowIdColumn;this.listParameterName=a.listParameterName;this.fileParameterName=a.fileParameterName||"file";this.callee={};this.init();return this.callee};k.prototype.requiredValidator=
function(a){if(null==a||!g.call(a,"rowIdColumn"))throw new SyntaxError('[SFMGrid] constructor property "rowIdColumn" is required');if(!g.call(a,"listParameterName"))throw new SyntaxError('[SFMGrid] constructor property "listParameterName" is required');g.call(a,"fileParameterName")||console.warn('[SFMGrid] constructor property "fileParameterName" is not define')};k.prototype.init=function(){this.makeCallee()};k.prototype.makeCallee=function(){this.callee.get=this.get.bind(this);this.callee.set=this.set.bind(this);
this.callee.remove=this.remove.bind(this);this.callee.clear=this.clear.bind(this);this.callee.getFormDataFromObject=this.getFormDataFromObject.bind(this);this.callee.getFormDataFromArray=this.getFormDataFromArray.bind(this)};k.prototype.get=function(a){return this.fileMap[a[this.rowIdColumn]]};k.prototype.set=function(a,b){this.fileMap[a[this.rowIdColumn]]=b};k.prototype.remove=function(a){delete this.fileMap[a[this.rowIdColumn]]};k.prototype.clear=function(a){this.fileMap.clear()};k.prototype.getFormDataFromObject=
function(a){a=new FormData;for(var b in this.fileMap)this.rowIdColumn===b&&g.call(this.fileMap,this.fileMap[this.rowIdColumn])&&a.append(this.fileParameterName,this.fileMap[this.fileMap[this.rowIdColumn]]),a.append(b,this.fileMap[b]);return a};k.prototype.getFormDataFromArray=function(a){if(0==a.length)return null;var b=this,c=new FormData,e=this.copyObject(this.fileMap);a.forEach(function(a,d){for(var f in a)b.rowIdColumn===f&&g.call(e,a[b.rowIdColumn])&&(c.append(b.listParameterName+"["+d+"]."+
b.fileParameterName,e[a[b.rowIdColumn]]),delete e[a[b.rowIdColumn]]),c.append(b.listParameterName+"["+d+"]."+f,a[f])});return c};k.prototype.copyObject=function(a){var b={},c;for(c in a)b[c]=a[c];return b};return{SFM:c,SFMGrid:k}}(function(){var f=function(){this.tail=this.head=null;this.map=Object.create(null);this.length=0;this.hasProp=Object.prototype.hasOwnProperty};f.prototype.clear=function(){this.tail=this.head=null;this.map=Object.create(null);this.length=0};f.prototype.get=function(e){return(this.hasProp.call(this.map,
e)?this.map[e]:{}).value};f.prototype.size=function(){return this.map.length};f.prototype.getByIndex=function(e){return this.getItemByIndex(e).value};f.prototype.getIndexByKey=function(e){return this.getItemByKey(e).index};f.prototype.getItemByKey=function(e){var g=null;this.each(function(c,f){if(e===c.key)return g={index:f,key:c.key,value:c.value},!1});return g};f.prototype.getItemByIndex=function(e){var g=null;this.each(function(c,f){if(e==f)return g={index:f,key:c.key,value:c.value},!1});return g};
f.prototype.isContainsKey=function(e){return this.hasProp.call(this.map,e)?!0:!1};f.prototype.put=function(e,g){this.remove(e);var c={key:e,value:g,prev:this.tail,next:null};this.map[e]=c;0===this.length&&(this.head=c);this.tail&&(this.tail.next=c);this.tail=c;this.length+=1};f.prototype.remove=function(e){if(this.hasProp.call(this.map,e)){var g=this.map[e];this.head===g&&(g.next&&(g.next.prev=null),this.head=g.next);this.tail===g&&(g.prev&&(g.prev.next=null),this.tail=g.prev);g.next&&(g.next.prev=
g.prev);g.prev&&(g.prev.next=g.next);delete this.map[e];--this.length}};f.prototype.each=function(e){for(var g=0,c=this.length,f=this.head,a;g<c;){a={key:f.key,value:f.value};if(!1===e(a,g))break;f=f.next;g++}};f.prototype.eachRvs=function(e){for(var g=this.length,c=this.tail,f;0<g;){f={key:c.key,value:c.value};if(!1===e(f,g))break;c=c.prev;g--}};f.prototype.array=function(){var e=[];this.each(function(f,c){e.push(f.value)});return e};f.prototype.arrayRvs=function(){var e=[];this.reverseEach(function(f,
c){e.push(f.value)});return e};return f}(),function(){var f=function(){this.queue=[];this.isIng=!1;this.onReject=this.onError=null};f.prototype.run=function(e){if(0<this.queue.length&&!this.isIng){this.isIng=!0;try{this.queue.shift()(this.makeResolve(),this.makeReject(),e)}catch(g){this.onError?this.onError(g):console.error(g.message)}}};f.prototype.then=function(e){this.queue.push(e);this.run();return this};f.prototype.error=function(e){this.onError=e;return this};f.prototype.stop=function(){this.queue=
[];this.isIng=!1};f.prototype.reject=function(e){this.onReject=e;return this};f.prototype.makeResolve=function(){return function(e){this.isIng=!1;this.run(e)}.bind(this)};f.prototype.makeReject=function(){return function(e){this.stop();if(this.onReject)this.onReject(e)}.bind(this)};return f}()));