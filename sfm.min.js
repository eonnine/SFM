(function(f){"function"===typeof define&&void 0!==define.amd&&define(function(){return f});if("object"===typeof module&&"object"===typeof module.exports)module.exports=f;else for(var e in f)this[e]=f[e]})(function(f,e){var g=Object.prototype.hasOwnProperty,b=function(a){if(!(this instanceof b))throw new SyntaxError('[SFM] "new" constructor operator is required');this.requiredValidator(a);this.fileMap=new f;this.isIngRemove=this.isIngDownload=this.isIngUpload=!1;this.option=a;this.callee={};this.init(a);
return this.callee};b.prototype.requiredValidator=function(a){if(null==a||!g.call(a,"id"))throw new SyntaxError('[SFM] constructor property "id" is required');};b.prototype.config={key:{fileIdx:"number",fileSeq:"string"},fix:{item:"item",item_key_area:"item-key-area",file_upload:"upload-file",file_remove:"remove-file",file_download:"download-file",input_file:"input-file",item_area:"file-area"},file:{file_size:"52428800",file_count:0,file_extension:[],file_extension_except:[],file_parameter_name:"file",
file_list_parameter_name:"files"},message:{file_remove:"\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?",file_already_exist:"\ub3d9\uc77c\ud55c \uc774\ub984\uc758 \ud30c\uc77c\uc774 \uc774\ubbf8 \ub4f1\ub85d\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4",file_size_max_overflow:"\ud5c8\uc6a9\ub41c \ud06c\uae30(50mb)\ubcf4\ub2e4 \uc6a9\ub7c9\uc774 \ud070 \ud30c\uc77c\uc785\ub2c8\ub2e4",file_count_over:"\ud5c8\uc6a9\ub41c \uac1c\uc218\ub97c \ucd08\uacfc\ud569\ub2c8\ub2e4",file_extension:"\ud5c8\uc6a9\ub41c \ud655\uc7a5\uc790\uac00 \uc544\ub2d9\ub2c8\ub2e4.",
file_extension_except:"\ud5c8\uc6a9\ub41c \ud655\uc7a5\uc790\uac00 \uc544\ub2d9\ub2c8\ub2e4.",file_get_error:"\ud30c\uc77c \ubaa9\ub85d\uc744 \ubd88\ub7ec\uc624\ub294 \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",file_upload_error:"\ud30c\uc77c \uc5c5\ub85c\ub4dc \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",file_remove_error:"\ud30c\uc77c \uc0ad\uc81c \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",file_download_error:"\ud30c\uc77c \ub2e4\uc6b4\ub85c\ub4dc \ub3c4\uc911 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.",
file_upload_is_ing:"\uc5c5\ub85c\ub4dc \uc911\uc785\ub2c8\ub2e4",file_remove_is_ing:"\uc0ad\uc81c \uc911\uc785\ub2c8\ub2e4",file_download_is_ing:"\ub2e4\uc6b4\ub85c\ub4dc \uc911\uc785\ub2c8\ub2e4"},layout:function(a,c){return'<fieldset><button id="'+c+'" style="float:right; position:relative; bottom:13px;">upload</button><div id="'+a+'" style="z-index:1;" width="100%" height="100%" default-class-dropzone><p dropzone-file-area-message></p></div></fieldset>'},item:function(a,c,d){return'<span style="z-index:10;"><p>&nbsp;&nbsp;<b id="'+
d+'" style="width:12px; height:12px; margin-left:5px; font-size:12px; cursor:pointer;">\u25bc</b>&nbsp;file: <strong>'+a.name+"</strong>&nbsp;&nbsp;&nbsp;type: <strong>"+a.type+"</strong>&nbsp;&nbsp;&nbsp;size: <strong>"+a.size+'</strong>bytes<data style="display:none;"></data><b style="width:12px; height:12px; margin-left:5px; font-size:12px; cursor:pointer;" id="'+c+'">X</b></p></span>'},url:{file_get_list:"",file_upload:"",file_remove:"",file_download:""},event:{file_upload:"click",file_remove:"click",
file_download:"click"},eventHandler:{layout_create_after:function(a){var c=function(a){a.stopPropagation();a.preventDefault();a.target.className="mouseover"==a.type||"mouseenter"==a.type?"mhover":""},d=function(a){a.stopPropagation();a.preventDefault();a.target.className="dragover"==a.type||"dragenter"==a.type?"hover":""};a=a.fileArea;a.addEventListener("mouseover",c,!1);a.addEventListener("mouseenter",c,!1);a.addEventListener("mouseleave",c,!1);a.addEventListener("dragover",d,!1);a.addEventListener("dragenter",
d,!1);a.addEventListener("dragleave",d,!1)},file_upload_before:function(a){console.log("uploadStart")},file_upload_after:function(a){console.log("uploadEnd")},file_remove_before:function(a){console.log("removeStart")},file_remove_after:function(a){console.log("removeEnd")},file_download_before:function(){console.log("downloadStart")},file_download_after:function(a){console.log("downloadEnd")}}};b.prototype.getConfig=function(){var a=this.searchProp(this.option,arguments);null===a&&(a=this.searchProp(this.config,
arguments));return a};b.prototype.searchProp=function(a,c){var d,k;for(d=0;k=c[d];d++)if(g.call(a,k))a=a[k];else return null;return a};b.prototype.setConfig=function(a){this.initConfig(a,[])};b.prototype.initConfig=function(a,c){c=null==c?this.config:c;for(var d in a)"fix"!==d&&("object"===typeof c[d]&&g.call(c,d)&&"Object"==c[d].constructor.name?this.initConfig(a[d],c[d]):c[d]=a[d])};b.prototype.getElement=function(a){return document.getElementById(a)};b.prototype.makeElementId=function(a){this.elementId=
{};this.elementId.item=this.makeConfigId("fix","item");this.elementId.fileArea=this.makeConfigId("fix","item_area");this.elementId.fileUpload=this.makeConfigId("fix","file_upload");this.elementId.fileRemove=this.makeConfigId("fix","file_remove");this.elementId.itemKeyArea=this.makeConfigId("fix","item_key_area");this.elementId.fileDownload=this.makeConfigId("fix","file_download");this.elementId.fileInputElement=this.makeConfigId("fix","input_file")};b.prototype.makeConfigId=function(){return this.addSeparator(this.option.id,
this.getConfig.apply(this,arguments))};b.prototype.addSeparator=function(){var a,c=arguments.length,d="";for(a=0;a<c;a++)d+=arguments[a]+"-";return d.slice(0,-1)};b.prototype.makeCallee=function(){this.callee.getFilesFromUrl=this.getFilesFromUrl.bind(this);this.callee.uploadFile=this.uploadFile.bind(this);this.callee.getNewFiles=this.getNewFiles.bind(this);this.callee.getFileToFormData=this.getFileToFormData.bind(this);this.callee.getNewFileToFormData=this.getNewFileToFormData.bind(this)};b.prototype.freezeProperty=
function(){Object.freeze(this.callee);Object.defineProperties(this,{fileMap:{configurable:!1,writable:!1},isIngUpload:{configurable:!1},isIngDownload:{configurable:!1},isIngRemove:{configurable:!1}})};b.prototype.init=function(a){this.makeElementId();this.createLayout();this.createDefaultEventListener();this.makeCallee();this.freezeProperty()};b.prototype.createLayout=function(){var a=this.elementId.fileArea,c=this.elementId.fileUpload,d=this.getElement(this.option.id);d.innerHTML=this.getConfig("layout")(a,
c);d.insertAdjacentHTML("afterbegin",'<input type="file" id="'+this.elementId.fileInputElement+'" multiple="multiple" style="display:none;"/>');a=this.getElement(a);c=this.getElement(c);null!=c&&this.addCustomEvent(c,this.getConfig("event","file_upload"),this.uploadFile.bind(this));this.callConfigEventHandler("layout_create_after",{fileArea:a,fileUploadElement:c})};b.prototype.createDefaultEventListener=function(){var a=this.getElement(this.elementId.fileArea),c=this.getElement(this.elementId.fileInputElement);
this.addCustomEvent(a,"click",this.openInputFile.bind(this)).addCustomEvent(a,"drop",this.addNewFile.bind(this)).addCustomEvent(a,"mouseover",this.preventEvent.bind(this)).addCustomEvent(a,"mouseenter",this.preventEvent.bind(this)).addCustomEvent(a,"dragover",this.preventEvent.bind(this)).addCustomEvent(a,"mouseenter",this.preventEvent.bind(this)).addCustomEvent(c,"change",this.addNewFile.bind(this))};b.prototype.openInputFile=function(a){this.preventEvent(a);this.getElement(this.elementId.fileInputElement).click()};
b.prototype.addNewFile=function(a){this.preventEvent(a);for(var c=a.target.files||a.dataTransfer.files,d=0,k;k=c[d];d++){if(!this.addFileStopValidator(k))return;var b=this.makeItemKey(k.name);k=this.createNewFile(k,b);this.addFileToFileMap(k,!0);this.addItem(k)}a.target.value=""};b.prototype.addFileStopValidator=function(a){var c=a.name;c=c.substring(c.lastIndexOf(".")+1,c.length);var d=this.getConfig("file","file_extension"),k=this.getConfig("file","file_extension_except"),b=this.getConfig("file",
"file_count");if(this.fileMap.isContainsKey(a.name))return alert(this.getConfig("message","file_already_exist")),!1;if(a.size>this.getConfig("file","file_size"))return alert(this.getConfig("message","file_size_max_overflow")),!1;if(0!==b&&b<this.fileMap.size())return alert(this.getConfig("message","file_count_over")),!1;for(a=0;b=d[a];a++)if(c!==b)return alert(this.getConfig("message","file_extension")),!1;for(a=0;d=k[a];a++)if(c===d)return alert(this.getConfig("message","file_extension_except")),
!1;return!0};b.prototype.createNewFile=function(a,c){return a};b.prototype.makeItemKey=function(a){return a};b.prototype.addFile=function(a){for(var c=0,d;d=a[d];c++)g.call(d,"name")?(this.addFileToFileMap(d,!1),this.addItem(d)):console.error('[SFM] not exists attribute "name" in file object',d)};b.prototype.addFileToFileMap=function(a,c){a.isNewFile=c;this.fileMap.put(a.name,a)};b.prototype.addItem=function(a){var c=this.addSeparator(this.elementId.fileRemove,a.name),d=this.addSeparator(this.elementId.fileDownload,
a.name),k=this.getElement(this.elementId.fileArea),b=this.getConfig("key"),g=this.elementId.itemKeyArea,e="",f=this.addSeparator(this.elementId.item,a.name),h=this.getConfig("item")(a,c,d);Object.keys(b).forEach(function(c,d){0===d&&(e="<span "+g+">");e+='<input type="hidden" id="'+c+'" value="'+(a[c]?a[c]:"")+'"/>';d==b.length-1&&(e+="</span>")});k.insertAdjacentHTML("beforeend",'<span id="'+f+'">'+h+e+"</span>");c=this.getElement(c);d=this.getElement(d);c&&this.addCustomEvent(c,this.getConfig("event",
"file_remove"),this.removeFile.bind(this,f,this.createNewFile(a,a.name)));d&&this.addCustomEvent(d,this.getConfig("event","file_download"),this.downloadFile.bind(this,f,this.createNewFile(a,a.name)))};b.prototype.removeFile=function(a,c,d){if(this.isIngRemove)return alert(this.getConfig("message","file_remove_is_ing")),!1;if(!confirm(this.getConfig("message","file_remove")))return!1;this.isIngRemove=!0;this.preventEvent(d);var b=this;d=new e;var g=c.name,f=b.getElement(a),h=b.makeParamFile(c),l=b.getConfig("url",
"file_remove");d.then(function(a,d){b.callConfigEventHandler("file_remove_before",{file:c,item:f})?a():d()}).then(function(a,c){if(null==l||""===b.trim(l))l=location.href;try{b.ajax.post(l,h,function(c){a(c)})}catch(p){console.error("[SFM] fail remove file:",l,p),c(),alert(b.getConfig("message","file_remove_error"))}}).then(function(a,c,d){b.removeSelf(f);b.fileMap.remove(g);b.callConfigEventHandler("file_remove_after",{response:d});b.isIngRemove=!1})};b.prototype.downloadFile=function(a,c,d){this.isIngDownload=
!0;this.preventEvent(d);var b=this;d=new e;var g=b.getElement(a),f=b.getConfig("url","file_download");d.then(function(a,d){b.callConfigEventHandler("file_download_before",{file:c,item:g})?a():d()}).then(function(a,c){if(null!=f&&""!==b.trim(f))try{location.href=f,a()}catch(n){console.error("[SFM] fail download file:",f,n),c(),alert(b.getConfig("message","file_download_error"))}else console.warn("[SFM] downloadURL is not define")}).then(function(){b.callConfigEventHandler("file_download_after");b.isIngDownload=
!1})};b.prototype.uploadFile=function(){if(this.isIngUpload)return alert(this.getConfig("message","file_upload_is_ing")),!1;this.isIngUpload=!0;var a=this,c=new e,d=a.makeParamFiles(),b=a.getConfig("url","file_upload");c.then(function(c,d){a.callConfigEventHandler("file_upload_before")?c():d()}).then(function(c,g){if(null==b||""===a.trim(b))b=location.href;try{a.ajax.post(b,d,function(a){c(a)})}catch(m){console.error("[SFM] fail upload:",b,m),g(),alert(a.getConfig("message","file_upload_error"))}}).then(function(c,
d,b){a.callConfigEventHandler("file_upload_after",{response:b});a.isIngUpload=!1})};b.prototype.removeSelf=function(a){a.parentNode.removeChild(a)};b.prototype.makeParamFile=function(a){var c=new FormData;this.setParamFormData(c,a,!1);return c};b.prototype.makeParamFiles=function(a,c){a=a?a:new FormData;var d=this.fileMap.array();c=c?c:!1;d.forEach(function(d,b){this.setParamFormData(a,d,!0,b,c)}.bind(this));return a};b.prototype.setParamFormData=function(a,c,d,b,e){var f=this.addSeparator(this.elementId.item,
c.name);f=this.getElement(f).querySelector("["+this.elementId.itemKeyArea+"]").childNodes;var k=this.getConfig("key"),h;if(!e||e&&c.isNewFile){for(h=0;h<f.length;h++)e=f[h],g.call(k,e.id)&&a.append(this.getParamName(d,!1,b,e.id),"number"===k[e.id].toLowerCase()?Number(e.value):String(e.value));a.append(this.getParamName(d,!0,b),c)}};b.prototype.getParamName=function(a,c,b,e){b=this.getConfig("file","file_list_parameter_name")+"["+b+"].";var d=this.getConfig("file","file_parameter_name");return a?
c?b+d:b+e:c?d:e};b.prototype.getFileToFormData=function(a){return this.makeParamFiles(a)};b.prototype.getNewFileToFormData=function(a){return this.makeParamFiles(a,!0)};b.prototype.getFilesFromUrl=function(a){var c=this.getConfig("url","file_get_list"),b=this;try{b.ajax.get(c,a,function(a){b.addFile(a)})}catch(k){console.error("[SFM] getFilesFromUrl:",c,k),alert(b.getConfig("message","file_get_error"))}};b.prototype.getFiles=function(){var a=[];this.fileMap.each(function(c,b){a.push(c.value)});return a};
b.prototype.getNewFiles=function(){var a=[];this.fileMap.each(function(c,b){c.value.isNewFile&&a.push(c.value)});return a};b.prototype.addCustomEvent=function(a,c,b){void 0===a._$sfmEventListeners&&(a._$sfmEventListeners={});a._$sfmEventListeners[c]=function(a){a.stopPropagation();a.preventDefault();b(a)};a.addEventListener(c,a._$sfmEventListeners[c],!1);g.call(a._$sfmEventListeners,"DOMNodeRemovedFromDocument")||this.addCustomEvent(a,"DOMNodeRemovedFromDocument",function(a){this._$sfmEventListeners&&
(Object.keys(this._$sfmEventListeners).forEach(function(a){this.removeEventListener(a,this._$sfmEventListeners[a]);delete this._$sfmEventListeners[a]}.bind(this)),delete this._$sfmEventListeners)}.bind(this));return this};b.prototype.callConfigEventHandler=function(a,c){var b=this.option;c=void 0===c?{}:c;c.self=this.getElement(b.id);var e=this.searchProp(this.config,["eventHandler",a])(this.copyObject(c));!1!==e&&g.call(b,"eventHandler")&&g.call(b.eventHandler,a)&&(e=b.eventHandler[a](this.copyObject(c)));
return!1===e?!1:!0};b.prototype.preventEvent=function(a){a.stopPropagation();a.preventDefault()};b.prototype.copyObject=function(a){if("string"===typeof a)var c=a;else{c={};for(var b in a)c[b]=a[b]}return c};b.prototype.trim=function(a){return a.replace(/\s/g,"")};b.prototype.ajax={get:function(a,c,b,e){this.xhr("GET",a,c,b,e)},post:function(a,c,b,e){this.xhr("POST",a,c,b,e)},xhr:function(a,c,b,e,g){var d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.onload=function(a){4==
this.readyState&&200==this.status?e&&e(a.target.response,d):g&&g(d)};d.open(a,c,!0);d.setRequestHeader("encType","multipart/form-data");d.send(b)}};var h=function(a){if(!(this instanceof h))throw new SyntaxError('[SFMGrid] "new" constructor operator is required');this.requiredValidator(a);this.fileMap=Object.create(null);this.rowIdColumn=a.rowIdColumn;this.listParameterName=a.listParameterName;this.fileParameterName=a.fileParameterName||"file";this.callee={};this.init();return this.callee};h.prototype.requiredValidator=
function(a){if(null==a||!g.call(a,"rowIdColumn"))throw new SyntaxError('[SFMGrid] constructor property "rowIdColumn" is required');if(!g.call(a,"listParameterName"))throw new SyntaxError('[SFMGrid] constructor property "listParameterName" is required');g.call(a,"fileParameterName")||console.warn('[SFMGrid] constructor property "fileParameterName" is not define')};h.prototype.init=function(){this.makeCallee()};h.prototype.makeCallee=function(){this.callee.get=this.get.bind(this);this.callee.set=this.set.bind(this);
this.callee.remove=this.remove.bind(this);this.callee.clear=this.clear.bind(this);this.callee.getFormDataFromObject=this.getFormDataFromObject.bind(this);this.callee.getFormDataFromArray=this.getFormDataFromArray.bind(this)};h.prototype.get=function(a){return this.fileMap[a[this.rowIdColumn]]};h.prototype.set=function(a,b){this.fileMap[a[this.rowIdColumn]]=b};h.prototype.remove=function(a){delete this.fileMap[a[this.rowIdColumn]]};h.prototype.clear=function(a){this.fileMap.clear()};h.prototype.getFormDataFromObject=
function(a){a=new FormData;for(var b in this.fileMap)this.rowIdColumn===b&&g.call(this.fileMap,this.fileMap[this.rowIdColumn])&&a.append(this.fileParameterName,this.fileMap[this.fileMap[this.rowIdColumn]]),a.append(b,this.fileMap[b]);return a};h.prototype.getFormDataFromArray=function(a){if(0==a.length)return null;var b=this,d=new FormData,e=this.copyObject(this.fileMap);a.forEach(function(a,c){for(var f in a)b.rowIdColumn===f&&g.call(e,a[b.rowIdColumn])&&(d.append(b.listParameterName+"["+c+"]."+
b.fileParameterName,e[a[b.rowIdColumn]]),delete e[a[b.rowIdColumn]]),d.append(b.listParameterName+"["+c+"]."+f,a[f])});return d};h.prototype.copyObject=function(a){var b={},d;for(d in a)b[d]=a[d];return b};return{SFM:b,SFMGrid:h}}(function(){var f=function(){this.tail=this.head=null;this.map=Object.create(null);this.length=0;this.hasProp=Object.prototype.hasOwnProperty};f.prototype.clear=function(){this.tail=this.head=null;this.map=Object.create(null);this.length=0};f.prototype.get=function(e){return(this.hasProp.call(this.map,
e)?this.map[e]:{}).value};f.prototype.size=function(){return this.map.length};f.prototype.getByIndex=function(e){return this.getItemByIndex(e).value};f.prototype.getIndexByKey=function(e){return this.getItemByKey(e).index};f.prototype.getItemByKey=function(e){var g=null;this.each(function(b,f){if(e===b.key)return g={index:f,key:b.key,value:b.value},!1});return g};f.prototype.getItemByIndex=function(e){var g=null;this.each(function(b,f){if(e==f)return g={index:f,key:b.key,value:b.value},!1});return g};
f.prototype.isContainsKey=function(e){return this.hasProp.call(this.map,e)?!0:!1};f.prototype.put=function(e,g){this.remove(e);var b={key:e,value:g,prev:this.tail,next:null};this.map[e]=b;0===this.length&&(this.head=b);this.tail&&(this.tail.next=b);this.tail=b;this.length+=1};f.prototype.remove=function(e){if(this.hasProp.call(this.map,e)){var g=this.map[e];this.head===g&&(g.next&&(g.next.prev=null),this.head=g.next);this.tail===g&&(g.prev&&(g.prev.next=null),this.tail=g.prev);g.next&&(g.next.prev=
g.prev);g.prev&&(g.prev.next=g.next);delete this.map[e];--this.length}};f.prototype.each=function(e){for(var g=0,b=this.length,f=this.head,a;g<b;){a={key:f.key,value:f.value};if(!1===e(a,g))break;f=f.next;g++}};f.prototype.eachRvs=function(e){for(var f=this.length,b=this.tail,h;0<f;){h={key:b.key,value:b.value};if(!1===e(h,f))break;b=b.prev;f--}};f.prototype.array=function(){var e=[];this.each(function(f,b){e.push(f.value)});return e};f.prototype.arrayRvs=function(){var e=[];this.reverseEach(function(f,
b){e.push(f.value)});return e};return f}(),function(){var f=function(){this.queue=[];this.isIng=!1;this.onReject=this.onError=null};f.prototype.run=function(e){if(0<this.queue.length&&!this.isIng){this.isIng=!0;try{this.queue.shift()(this.makeResolve(),this.makeReject(),e)}catch(g){this.onError?this.onError(g):console.error(g.message)}}};f.prototype.then=function(e){this.queue.push(e);this.run();return this};f.prototype.error=function(e){this.onError=e;return this};f.prototype.stop=function(){this.queue=
[];this.isIng=!1};f.prototype.reject=function(e){this.onReject=e;return this};f.prototype.makeResolve=function(){return function(e){this.isIng=!1;this.run(e)}.bind(this)};f.prototype.makeReject=function(){return function(e){this.stop();if(this.onReject)this.onReject(e)}.bind(this)};return f}()));